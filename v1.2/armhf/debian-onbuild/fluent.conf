<source>
  @type systemd
  tag logs.*
  path /run/log/journal
  matches [{ "_SYSTEMD_UNIT": "balena.service" }]
</source>

# Expand docker logs to proper records
<filter>
  @type docker
</filter>

# Remove bits we don't care about
<filter>
  @type record_transformer
  <record>
    tag ${tag}
  </record>
  remove_keys container_id,container_name, source
</filter>

# Add docker container parts

<match> # This is matching everything
   @type mqtt
   host "#{ENV['MQTT_SERVER']}"
   port "#{ENV['MQTT_PORT']}"
   client_id "#{ENV['MQTT_CLIENT_ID']}"
   <security>
     username "#{ENV['MQTT_USERNAME']}"
     password "#{ENV['MQTT_PASSWORD']}"
   </security>
   topic_rewrite_pattern '^.*$'
   topic_rewrite_replacement "#{ENV['MQTT_TOPIC']}"
   <format>
     @type json
   </format>
   <inject>
     time_key @log_time
     time_type unixtime
    </inject>
</match>

